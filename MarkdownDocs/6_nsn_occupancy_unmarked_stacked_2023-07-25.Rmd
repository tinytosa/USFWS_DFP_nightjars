---
title: "6_nightjar surveys_single-season occupancy_stacked years"
author: "Marie I. Tosa"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

require(unmarked)
require(plyr)
require(dplyr)
require(tidyr)

require(ggplot2)
require(ggpubr)
```

## Create functions to plot figures
```{r}
vals.coefs <- function(mod)
{
coefs <- coef(mod) %>% tibble::enframe() #extract coefficients for covariates
se <- SE(mod) %>% tibble::enframe() #extract SEs for covariates

ci.psi <- confint(mod, type="state") %>% tibble::enframe()
ci.det <- confint(mod, type="det") %>% tibble::enframe()
ci <- rbind(ci.psi, ci.det) #combine psi and det CIs
ci <- data.frame(name=ci$name, lower=ci$value[,1], upper=ci$value[,2]) #need to split up ci so can read as data frame with lower and upper bounds

coefs <- merge(coefs, se, by="name") #merge coefficient values and ses
coefs <- merge(coefs, ci) #merge coefs with CIs
coefs <- data.frame(coefs)
names(coefs) <- c("par", "est", "se", "lower","upper")

coefs$p <- gsub(substr(coefs$par, 0,3), pattern="p\\([A-z]", replacement="det")
coefs$name <- gsub(coefs$par, pattern="scale\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="p\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="psi\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="\\)\\)", replacement="")
coefs$name <- gsub(coefs$name, pattern="Int\\)", replacement="Int")
coefs$name <- gsub(coefs$name, pattern="\\)", replacement="")
coefs$name <- gsub(coefs$name, pattern="I\\(", replacement="")
return(coefs)
}

```

## load data
data:
- removed ME 2nd and 3rd surveys (only kept 1st survey to stay consistent with other states)
- removed minutes 7-10 of CT surveys to stay consistent with protocols from other states

```{r}
ewpw.data <- read.csv("../Data_processed/occupancy_detectionhistory_stacked_EWPW.csv")
cwwi.data <- read.csv("../Data_processed/occupancy_detectionhistory_stacked_CWWI.csv")
coni.data <- read.csv("../Data_processed/occupancy_detectionhistory_stacked_CONI.csv")

#select data here
data <- ewpw.data
# data <- cwwi.data
# data <- coni.data

#remove 2023 data since only from DE
data <- data[data$year != 2023,]

#remove rows where there is no detection information
data <- data[!is.na(data$MaxDetections),]
data <- data[data$MaxDetections != "-Inf",]

#reorder data by state and year
data <- data[order(data$state, data$year),]

#start with only data with all covariates (remove rows with NA in siteCovs)
summary(data)

# data <- data[!is.na(data$start_date_j),] #removes most of NH sites since they don't have month/day or start_time info

data$noise <- as.numeric(data$noise)
data$moon <- as.numeric(data$moon)

# data <- data[!is.na(data$sky),]
data <- data[!is.na(data$moon),]
data <- data[!is.na(data$noise),]

#fix classes for data
data$hour <- as.factor(data$hour)

nrow(data) #20,493 rows
summary(data)

sum(data$TotalDetections) #this should match number of 1s in the summary of the umf

plot(data$hour, data$TotalDetections)
plot(data$hour, data$MaxDetections)

#####
#remove data without BCR information
data <- data[!is.na(data$BCR),] #remove sites without BCR info
data <- data[!is.na(data$year),] #remove sites without year info

data$BCR <- factor(data$BCR)
data$year <- factor(data$year)

table(data$state)

nrow(data) #EWPW: 20,493 rows for detection models, 19,737 rows for occupancy models
summary(data)

sum(data$TotalDetections) #this should match number of 1s in the summary of the umf

```

## create umf for stacked single-season occupancy model
```{r}
sp.stacked <- data[,grep(names(data), pattern="min")]
sp.stacked[sp.stacked > 1 & !is.na(sp.stacked)] <- 1 #convert > 1 to 1 (presence/absence instead of counts)

#check detection histories
unique(sp.stacked)

site.stacked <- data[,!names(data) %in% grep(names(data), pattern="min", value=T)] #siteCovs

#add in transformations for variables
site.stacked$start_date_j2 <- scale(site.stacked$start_date_j)*scale(site.stacked$start_date_j)


min.df <- matrix(rep(1:6, times=nrow(sp.stacked)), byrow=T, ncol=6) #add obsCovs, dimensions the same as y data

umf <- unmarkedFrameOccu(y=sp.stacked, siteCovs=site.stacked, obsCovs=list(min=min.df))
head(umf)

# tiff(filename="../Figures/occupancy/dethist_nsn_EWPW_stacked.tiff", height=10, width=8, units="in", compression="lzw", res=400)
plot(umf)
# dev.off()

summary(umf)

#y=1/y=0
# 20794/(58592 + 20794) #only 26.2% of occasions where EWPW were detected (with all NA data removed) #for the detection only model
16702/(16702 + 96897) #only 14.7% of occasions where EWPW were detected #for the occupancy only model

```

## run detection models for stacked single season occupancy models
include random effect of route and state
```{r, echo=T}
null <- occu(~1 ~1, data=umf)
null.r <- occu(~(1|st_id) + (1|state) ~1, data=umf)
summary(null)

# Call:
# occu(formula = ~(1 | st_id) + (1 | state) ~ 1, data = umf)
# 
# Occupancy (logit-scale):
#  Estimate     SE     z P(>|z|)
#    -0.169 0.0197 -8.57   1e-17
# 
# Detection (logit-scale):
# Random effects:
#  Groups        Name Variance Std.Dev.
#   st_id (Intercept)   13.501    3.674
#   state (Intercept)    6.646    2.578
# 
# Fixed effects:
#  Estimate    SE     z  P(>|z|)
#     -3.86 0.915 -4.22 2.46e-05
# 
# AIC: 58024.25 
# Number of sites: 20493
# optim convergence code: 0
# optim iterations: 49 
# Bootstrap iterations: 0

plogis(-3.86) #detection -> 2% detection
plogis(-0.169) #occupancy -> 45.8% occupancy

#####
#detection models
#####
p.min <- occu(~scale(min) + (1|st_id) + (1|state) ~1, data=umf)

#
p.moon <- occu(~scale(moon) + (1|st_id) + (1|state) ~1, data=umf)
p.sky <- occu(~scale(sky) + (1|st_id) + (1|state) ~1, data=umf)
p.noise <- occu(~scale(noise) + (1|st_id) + (1|state) ~1, data=umf)

p.day <- occu(~scale(start_date_j) + (1|st_id) + (1|state) ~1, data=umf)
p.day2 <- occu(~scale(start_date_j) + I(scale(start_date_j) * scale(start_date_j)) + 
                 (1|st_id) + (1|state) ~1, data=umf)
p.month <- occu(~scale(start_month) + (1|st_id) + (1|state) ~1, data=umf)
p.month2 <- occu(~scale(start_month) + I(scale(start_month)*scale(start_month)) + 
                   (1|st_id) + (1|state) ~1, data=umf)
p.hour <- occu(~hour + (1|st_id) + (1|state) ~1, data=umf)
p.time <- occu(~scale(start_time_s) + (1|st_id) + (1|state) ~1, data=umf)

p.timecat <- occu(~start_time_cat + (1|st_id) + (1|state) ~1, data=umf)

p.global <- occu(~scale(min) + scale(noise) + 
                   scale(start_date_j) + I(scale(start_date_j)*scale(start_date_j)) +
                   scale(moon) + scale(sky) +
                   (1|st_id) + (1|state) ~1, data=umf)

# p.month2 <- occu(~scale(start_month) + I(scale(start_month)*scale(start_month))+ state + (1|st_id) ~1, data=umf) #change state from random to fixed effect, eats up a lot of parameters

p.fl <- fitList(null, null.r, p.min, #per minute within a survey
                p.moon, p.sky, p.noise, #site covariates
                p.day, p.day2, p.month, p.month2, p.time, p.timecat, p.hour, #timing of survey
                p.global) 
modSel(p.fl)
#           nPars      AIC   delta   AICwt cumltvWt
# p.global      8 50493.43    0.00 1.0e+00     1.00
# p.min         3 50733.71  240.28 6.6e-53     1.00
# p.noise       3 50747.75  254.32 6.0e-56     1.00
# p.day2        4 50808.50  315.07 3.8e-69     1.00
# p.month2      4 50843.70  350.27 8.7e-77     1.00 #correlated with day2
# p.day         3 50845.06  351.64 4.4e-77     1.00
# p.hour       20 50855.07  361.64 3.0e-79     1.00
# p.moon        3 50855.48  362.06 2.4e-79     1.00
# p.month       3 50867.46  374.03 6.0e-82     1.00
# p.timecat     5 50873.79  380.36 2.5e-83     1.00
# p.sky         3 50883.17  389.75 2.3e-85     1.00

# null.r        2 50883.86  390.43 1.7e-85     1.00
# p.time        3 50888.46  395.03 1.7e-86     1.00
# null          2 59172.12 8678.69 0.0e+00     1.00
```
## coefficients and marginal plots for detection variables
include random effect of route and state
```{r, echo=T}

p.global2 <- occu(~scale(min) + scale(noise) + 
                    scale(start_date_j) + start_date_j2 + 
                    scale(moon) + scale(sky) + (1|st_id) + (1|state) ~1, data=umf)

# mod <- p.global #choose model to extract coefficients from
mod <- p.global2

coefs <- coef(mod) %>% tibble::enframe() #extract coefficients for covariates
se <- SE(mod) %>% tibble::enframe() #extract SEs for covariates

ci.psi <- confint(mod, type="state") %>% tibble::enframe()
ci.det <- confint(mod, type="det") %>% tibble::enframe()
ci <- rbind(ci.psi, ci.det) #combine psi and det CIs
ci <- data.frame(name=ci$name, lower=ci$value[,1], upper=ci$value[,2]) #need to split up ci so can read as data frame with lower and upper bounds

coefs <- merge(coefs, se, by="name") #merge coefficient values and ses
coefs <- merge(coefs, ci) #merge coefs with CIs
coefs <- data.frame(coefs)
names(coefs) <- c("par", "est", "se", "lower","upper")

coefs$p <- gsub(substr(coefs$par, 0,3), pattern="p\\([A-z]", replacement="det")
coefs$name <- gsub(coefs$par, pattern="scale\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="p\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="psi\\(", replacement="")
coefs$name <- gsub(coefs$name, pattern="\\)\\)", replacement="")
coefs$name <- gsub(coefs$name, pattern="Int\\)", replacement="Int")
coefs$name <- gsub(coefs$name, pattern="\\)", replacement="")
coefs$name <- gsub(coefs$name, pattern="I\\(", replacement="")

c.plot <- ggplot(data=coefs[!coefs$name %in% "Int",], aes(x=name, y=est, group=p, shape=p)) +
  # c.plot <- ggplot(data=coefs[coefs$name != "INT",], aes(x=name, y=est)) +
  geom_point(size=3, position=position_dodge(width=0.5)) + 
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1, lwd=1, position=position_dodge(width=0.5)) +
  # geom_errorbar(aes(ymin=est-se, ymax=est+se), width=0, lwd=1, position=position_dodge(width=0.5)) +
  geom_hline(aes(yintercept=0), lty="dotted") +
  xlab("parameter") + ylab("estimate") +
  coord_flip() +
  theme_bw(base_size=16) + theme(panel.grid=element_blank()) + facet_wrap(.~p, scales="free", ncol=1)
c.plot

ggsave(c.plot, filename="../Figures/occupancy/stacked_occupancy_det_coefficients.tiff")

###########
#univariate model marginal plots
plotEffects(p.min, "det", covariate="min")
plotEffects(p.noise, "det", covariate="noise")
plotEffects(p.day2, "det", covariate="start_date_j")
plotEffects(p.month2, "det", covariate="start_month")
plotEffects(p.timecat, "det", covariate="start_time_cat")
plotEffects(p.hour, "det", covariate="hour")


###########
# #global model marginal plots for each covariate

mod <- p.global2

# plotEffects(mod, "det", covariate="start_date_j")
# 
# #not sure why these don't work...problem seems to be using I(date^2) notation
plotEffects(mod, "det", covariate="min")
plotEffects(mod, "det", covariate="noise")
plotEffects(mod, "det", covariate="moon")
plotEffects(mod, "det", covariate="sky")
# 
# ###########
# #manually plot marginals in ggplot2
nd.mean <- site.stacked %>% mutate_if(is.numeric, mean)
nd.mean <- nd.mean[1,] #only take first row since all rows are the same
nd.mean$min <- 1

ylabel <- data.frame(type=c("det","state"), label=c("detection","occupancy"))
#
plot.marginal <- function(par, par.name, type)
{
  nd <- data.frame(nd.mean[,names(nd.mean) != par],
                   par=seq(min(site.stacked[,par]), max(site.stacked[,par]), length.out=1000))
  names(nd) <- gsub(names(nd), pattern="par", replacement=par)
  marginal <- unmarked::predict(mod, type=type, newdata=nd)

  o <- ggplot(marginal, aes(x=nd[,par], y=Predicted)) +
    geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.5, fill="grey75") +
    geom_rug(data=site.stacked, aes(x=site.stacked[,par], y=0)) +
    ylim(0,1) +
    xlab(par.name) + ylab(paste("Predicted probability of", ylabel[ylabel$type == type,]$label)) +
    geom_line() + theme_bw(base_size=20) + theme(panel.grid=element_blank())
  print(o)
  ggsave(o, filename=paste("../Figures/occupancy/stacked_occupancy_",type,"_", par,".tiff", sep=""), height=6, width=6, unit="in", dpi=300, compression="lzw")
}

#plot these with p.global2, need to pull out scale() from within I() to plot these
plot.marginal("noise", "noise", type="det")
plot.marginal("moon", "moon", type="det")
plot.marginal("sky", "sky", type="det")

# plot.marginal("start_date_j", "start_date_j", type="det") #need to plot separately with p.global since have scale within I()

#for min
par <- "min"; par.name <- "minute"; type <- "det"
nd <- data.frame(nd.mean[,names(nd.mean) != par], par=1:6)
names(nd) <- gsub(names(nd), pattern="par", replacement=par)
marginal <- unmarked::predict(mod, type=type, newdata=nd)
o <- ggplot(marginal, aes(x=nd[,par], y=Predicted)) +
  geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.5, fill="grey75") +
  ylab(paste("Predicted probability of", ylabel[ylabel$type == type,]$label)) +ylim(0,1) +
  xlab(par.name) + scale_x_continuous(breaks=1:6) +
  geom_line() + theme_bw(base_size=20) + theme(panel.grid=element_blank())
print(o)
ggsave(o, filename=paste("../Figures/occupancy/stacked_occupancy_",type,"_", par,".tiff", sep=""), height=6, width=6, unit="in", dpi=300, compression="lzw")

```

## run occupancy models for stacked single season occupancy models
include random effect of route on occupancy, included state as a fixed effect

removed sites without BCR information (19737 sites)
Tabulation of y observations:
      0      1   <NA> 
 101666  16702     54

```{r, echo=T}
#####
#occupancy models
#####

null <- occu(~1 ~ (1|st_id), data=umf)

#univariate
o.state <- occu(~1 ~ state + (1|st_id), data=umf)
o.bcr <- occu(~1 ~ BCR + (1|st_id), data=umf) #removing this so can run models with more sites and BCR does not increase fit by much
o.year <- occu(~1 ~ year + (1|st_id), data=umf)

#covariate combinations
o.state.bcr <- occu(~1 ~ state + BCR + (1|st_id), data=umf)
o.state.year <- occu(~1 ~ state + year + (1|st_id), data=umf)

o.state.bcr.year <- occu(~1 ~ state + BCR + year + (1|st_id), data=umf)

o.fl <- fitList(null,
                o.bcr, o.state.bcr,
                o.state, o.year, 
                o.state.year, o.state.bcr.year
                )
modSel(o.fl)
#                  nPars      AIC  delta   AICwt cumltvWt
# o.state.bcr.year    34 42927.45   0.00 7.9e-01     0.79
# o.state.bcr         19 42930.04   2.59 2.1e-01     1.00
# o.state.year        28 42980.62  53.18 2.2e-12     1.00
# o.state             13 42981.71  54.26 1.3e-12     1.00
# o.bcr                8 42992.34  64.89 6.4e-15     1.00
# null                 2 43215.66 288.21 2.0e-63     1.00
# o.year              17 43216.38 288.94 1.4e-63     1.00

```

## plot occupancy only model figures
```{r}
# plotEffects(o.state, "state", covariate="state")
# plotEffects(o.bcr, "state", covariate="BCR")
# 
# plotEffects(o.state.year, "state", covariate="state")
# plotEffects(o.state.year, "state", covariate="year")
# 
# plotEffects(o.state.year, "state", covariate="state")
# plotEffects(o.state.year, "state", covariate="year")

plotEffects(o.state.bcr.year, "state", covariate="year")
plotEffects(o.state.bcr.year, "state", covariate="state")
plotEffects(o.state.bcr.year, "state", covariate="BCR")

####
#plot occupancy per state per BCR per year
####
# nd <- data.frame(state=rep(unique(data$state), times=length(unique(data$year))), 
#                  year=rep(unique(data$year), each=length(unique(data$state))),
#                  st_id="GA--270056") #have to provide this for predict to work

mod <- o.state.bcr.year
nd <- unique(site.stacked[,c("state","BCR","year","st_id")])
nd <- nd %>% #take first row of each group
  group_by(state, BCR, year) %>%
  arrange(st_id) %>%
  filter(row_number()==1)

marginal <- predict(mod, type="state", newdata=nd)

m.data <- cbind(nd, marginal)
m.data <- m.data[order(m.data$year, m.data$state),]
m.data$state <- factor(m.data$state, levels=rev(c("FL","GA","SC","NC","VA","WV","MD","DE","NJ","PA","NY","CT","MA","VT","NH","ME")))

p <- ggplot(m.data, aes(x=year, y=Predicted, col=BCR, fill=BCR)) +
  geom_hline(aes(yintercept=0), lty="dashed", col="grey50") + geom_hline(aes(yintercept=1), lty="dashed", col="grey50") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1, lwd=1, position=position_dodge(width=0.25)) +
  geom_point(size=5, pch=21, col="black", position=position_dodge(width=0.25)) +
  # geom_smooth(method="lm", col="grey50", lty="dashed") +
  scale_fill_brewer(palette="Set2") + scale_color_brewer(palette="Set2") +
  xlab("state") + ylab(paste("Predicted probability of occupancy")) + ylim(c(0,1)) +
  theme_bw(base_size=20) + theme(panel.grid=element_blank())
p + facet_wrap(~state, ncol=1)
ggsave(filename = "../Figures/occupancy/stacked_occupancy_psi_state-bcr-year.tiff", height=30, width=16, units="in", dpi=400, compression="lzw")

p + facet_wrap(~state, ncol=2, dir="v")
ggsave(filename = "../Figures/occupancy/stacked_occupancy_psi_state-bcr-year2.tiff", height=20, width=20, units="in", dpi=400, compression="lzw")

######
#plot values for each state
######
nd <- unique(site.stacked[,c("state","BCR","year","st_id")])
nd <- nd %>% #take first row of each group
  group_by(state) %>%
  arrange(st_id) %>%
  filter(row_number()==1)
marginal <- predict(mod, type="state", newdata=nd)
m.data <- cbind(nd, marginal)
m.data <- m.data[order(m.data$year, m.data$state),]
m.data$state <- factor(m.data$state, levels=rev(c("FL","GA","SC","NC","VA","WV","MD","DE","NJ","PA","NY","CT","MA","VT","NH","ME")))

ggplot(m.data, aes(x=state, y=Predicted)) +
  geom_hline(aes(yintercept=0), lty="dashed", col="grey50") + geom_hline(aes(yintercept=1), lty="dashed", col="grey50") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1, lwd=1, position=position_dodge(width=0.25)) +
  geom_point(size=5, col="black", position=position_dodge(width=0.25)) +
  xlab("state") + ylab(paste("Predicted probability of occupancy")) + ylim(c(0,1)) +
  theme_bw(base_size=20) + theme(panel.grid=element_blank())
ggsave(filename="../Figures/occupancy/stacked_occ_psi_state_EWPW.tiff", height=6, width=8, units="in", dpi=400, compression="lzw")

#######
#plot values for each BCR
#######
nd <- unique(site.stacked[,c("state","BCR","year","st_id")])
nd <- nd %>% #take first row of each group
  group_by(BCR) %>%
  arrange(st_id) %>%
  filter(row_number()==1)
marginal <- predict(mod, type="state", newdata=nd)
m.data <- cbind(nd, marginal)
m.data <- m.data[order(m.data$year, m.data$state),]
m.data$state <- factor(m.data$state, levels=rev(c("FL","GA","SC","NC","VA","WV","MD","DE","NJ","PA","NY","CT","MA","VT","NH","ME")))
m.data$BCR <- factor(m.data$BCR, levels=rev(c(31,27,29,28,30,13,14)))

ggplot(m.data, aes(x=BCR, y=Predicted)) +
  geom_hline(aes(yintercept=0), lty="dashed", col="grey50") + geom_hline(aes(yintercept=1), lty="dashed", col="grey50") +
  geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1, lwd=1, position=position_dodge(width=0.25)) +
  geom_point(size=5, col="black", position=position_dodge(width=0.25)) +
  xlab("BCR") + ylab(paste("Predicted probability of occupancy")) + ylim(c(0,1)) +
  theme_bw(base_size=20) + theme(panel.grid=element_blank())
ggsave(filename="../Figures/occupancy/stacked_occ_psi_BCR_EWPW.tiff", height=6, width=8, units="in", dpi=400, compression="lzw")

#can't really plot values for each year since each state was only samples sporadically

#######
#summarize and plot beta coefficients
#this isn't very useful. more useful to use predict and plot those values (as done above)
# psi.glob.info <- vals.coefs(mod = o.state.bcr.year)
# 
# psi.glob.info$level <- gsub(psi.glob.info$name, pattern="[0-9]{2,4}", replacement="")
# psi.glob.info[grep(psi.glob.info$level, pattern="state"),]$level <- "state"
# psi.glob.info$name2 <- gsub(gsub(psi.glob.info$name, pattern="state", replacement=""), pattern="year", replacement="")
# 
# c.data <- psi.glob.info
# c.plot <- ggplot(data=c.data[!c.data$name %in% "Int",], aes(x=name2, y=est, group=p, shape=p)) +
#   # c.plot <- ggplot(data=coefs[coefs$name != "INT",], aes(x=name, y=est)) +
#   geom_point(size=3, position=position_dodge(width=0.5)) + 
#   # geom_errorbar(aes(ymin=lower, ymax=upper), width=0.1, lwd=1, position=position_dodge(width=0.5)) +
#   # geom_errorbar(aes(ymin=est-se, ymax=est+se), width=0, lwd=1, position=position_dodge(width=0.5)) +
#   geom_hline(aes(yintercept=0), lty="dotted") +
#   xlab("parameter") + ylab("estimate") +
#   coord_flip() +
#   theme_bw(base_size=16) + theme(panel.grid=element_blank(), legend.position="none") + facet_wrap(.~level, scales="free", ncol=1)

```
## run det + psi models for stacked single season occupancy models
include random effect of route and state on detection
include random effect of route on occupancy

7493 sites
Maximum number of observations per site: 6 
Mean number of observations per site: 6 
Sites with at least one detection: 2359 

Tabulation of y observations:
    0     1 
35833  9125

*this is a much smaller dataset since need covariate info and BCR info*

```{r, echo=T}
#####
#detection + occupancy models
#####
null <- occu(~1 ~1, data=umf)
null.r <- occu(~(1|st_id) + (1|state) ~(1|st_id), data=umf)
  
p.global <- occu(~scale(min) + scale(noise) + 
                   scale(start_date_j) + I(scale(start_date_j)*scale(start_date_j)) +
                   scale(moon) + #scale(sky) + #removed since almost no effect
                   (1|st_id) + (1|state) ~1, data=umf)
o.global <- occu(~1 ~ state + BCR + year + (1|st_id), data=umf)

global <- occu(~scale(min) + scale(noise) + 
                   scale(start_date_j) + start_date_j2 +
                   scale(moon) + #scale(sky) + #remove since almost no effect
                   (1|st_id) + (1|state)
               ~state + BCR + year + (1|st_id), data=umf)

fl <- fitList(null, null.r,
                p.global, o.global, global)
modSel(fl)

#          nPars      AIC   delta    AICwt cumltvWt
# global      32 21560.77    0.00  1.0e+00     1.00
# null.r       2 21795.48  234.71  1.1e-51     1.00
# o.global    27 22023.46  462.69 3.4e-101     1.00
# p.global     7 23171.22 1610.44  0.0e+00     1.00
# null         2 27748.45 6187.68  0.0e+00     1.00
```


## plot marginals for stacked single season occupancy models
```{r, echo=T}

plotEffects(o.state.bcr.year, "state", covariate="year")
plotEffects(o.state.bcr.year, "state", covariate="state")
plotEffects(o.state.bcr.year, "state", covariate="BCR")
```